flowchart TD
    ENTRY(["Pagamento sem Pedido\n(sem order_id)"])

    ENTRY --> OP{"operation_type"}

    OP -->|"partition_transfer\n+ am-to-pot"| SAV["savings_pot\nTransferência Poupança\n(transfer)"]
    OP -->|"partition_transfer\noutros"| SKIP1["IGNORA\n(movimentação interna)"]
    OP -->|"payment_addition"| SKIP2["IGNORA\n(frete adicional de pedido)"]
    OP -->|"money_transfer"| MONEY{"É cashback\nou intra MP?"}

    MONEY -->|"cashback ML"| CASH["cashback\nReceita\ncat. 1.3.4 Estornos de Taxa\n✓ AUTO"]
    MONEY -->|"transferência interna MP"| INTRA["transfer_intra\nTransferência Interna\n(transfer)"]
    MONEY -->|"outro"| PIX["transfer_pix\nPIX / TED\n(transfer)"]

    OP -->|"bill_payment"| BILL{"É DARF?"}
    BILL -->|"sim (código Febraban)"| DARF["darf\nDespesa Fiscal\ncat. 2.2.7\n✓ AUTO"]
    BILL -->|"não"| BOLETO["bill_payment\nBoleto genérico\n(sem categoria auto)"]

    OP -->|"virtual (cartão virtual)"| VIR{"Beneficiário"}
    VIR -->|"Claude / Anthropic"| SaaS1["subscription\nAssinatura\ncat. 2.6.5 Claude\n✓ AUTO"]
    VIR -->|"Supabase"| SaaS2["subscription\nAssinatura\ncat. 2.6.4 Supabase\n✓ AUTO"]
    VIR -->|"Notion"| SaaS3["subscription\nAssinatura\ncat. 2.6.1 Notion\n✓ AUTO"]
    VIR -->|"outros"| SaaS4["subscription\nAssinatura\ncat. 2.6.1\n✓ AUTO"]

    OP -->|"collection"| COL["collection\nCobrança ML\ncat. 2.8.2 Comissões\n✓ AUTO"]

    OP -->|"outros (PIX sem branch)"| DEP["deposit\nDepósito\n(transfer)"]

    OP -->|"nenhum match"| OTH["other\nDespesa Genérica\n(sem categoria)"]

    subgraph RESULT["Resultado em mp_expenses"]
        AUTO["auto_categorized = true\nstatus = auto_categorized"]
        MANUAL["auto_categorized = false\nstatus = pending_review\n⚠️ Revisão manual necessária"]
    end

    CASH --> AUTO
    DARF --> AUTO
    SaaS1 --> AUTO
    SaaS2 --> AUTO
    SaaS3 --> AUTO
    SaaS4 --> AUTO
    COL --> AUTO

    SAV --> MANUAL
    INTRA --> MANUAL
    PIX --> MANUAL
    BOLETO --> MANUAL
    DEP --> MANUAL
    OTH --> MANUAL

    style SKIP1 fill:#ffcccc
    style SKIP2 fill:#ffcccc
    style AUTO fill:#d4edda
    style MANUAL fill:#fff3cd
