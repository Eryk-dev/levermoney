{
  "project": "Lever Money Conciliador V3 — Dashboard Admin",
  "branchName": "ralph/extrato-onboarding-frontend",
  "description": "Adapt the Admin Panel frontend to send multipart/form-data (instead of JSON) to the activate and upgrade-to-ca endpoints, add a required CSV file upload field in both modals for dashboard_ca mode, and display clear error/success feedback about extrato period coverage and ingestion results.",
  "userStories": [
    {
      "id": "US-F01",
      "title": "Adapt activateSeller and upgradeToCA hooks to send FormData",
      "description": "As a developer, I want the activateSeller and upgradeToCA functions in useAdmin.ts to send FormData instead of JSON so that the FastAPI backend (which now expects multipart/form-data) receives the fields and the extrato CSV file correctly.",
      "acceptanceCriteria": [
        "In dashboard/src/hooks/useAdmin.ts, add interface ExtratoProcessedStats { newly_ingested: number; total_lines: number; already_covered: number; errors: number; } above the existing interfaces",
        "Extend ActivateSellerConfig interface with field extrato_csv?: File",
        "Extend UpgradeToCAConfig interface with field extrato_csv: File",
        "Update the return type of activateSeller to Promise<{ status: string; backfill_triggered: boolean; extrato_processed?: ExtratoProcessedStats | null; error_detail?: string }>",
        "Update the return type of upgradeToCA to the same shape as activateSeller",
        "In activateSeller, replace the JSON fetch body with FormData: create fd = new FormData(), append each string field with fd.append(key, value ?? ''), and if config.extrato_csv append fd.append('extrato_csv', config.extrato_csv, config.extrato_csv.name)",
        "The fetch call in activateSeller must use headers: { 'X-Admin-Token': token ?? '' } WITHOUT Content-Type (browser sets multipart boundary automatically when body is FormData)",
        "On !res.ok in activateSeller, read errData = await res.json().catch(() => ({})) and return { status: 'error', backfill_triggered: false, error_detail: errData.detail ?? 'Erro desconhecido' }",
        "Apply the exact same FormData conversion and error handling to upgradeToCA",
        "Typecheck passes (run: cd dashboard && npx tsc --noEmit)"
      ],
      "priority": 1,
      "passes": true,
      "notes": "CRITICAL: The FastAPI endpoints now use Form() and File() parameters instead of a Pydantic JSON body. Sending Content-Type: application/json will cause a 422 Unprocessable Entity. The headers() helper in useAdmin sets Content-Type: application/json — do NOT use it for these two fetch calls. Build a plain object { 'X-Admin-Token': token } for headers instead. All string fields from ActivateSellerConfig must be appended individually: integration_mode, name, dashboard_empresa, dashboard_grupo, dashboard_segmento, ca_conta_bancaria, ca_centro_custo_variavel, ca_start_date. Skip appending if value is undefined/null (or append empty string — FastAPI Form(None) accepts empty string as None). Files live at: dashboard/src/hooks/useAdmin.ts"
    },
    {
      "id": "US-F02",
      "title": "Add extrato CSV upload field to the Activation modal",
      "description": "As an admin, I want a file upload input inside the activation modal (visible only in dashboard_ca mode) so I can attach the account_statement CSV before confirming activation.",
      "acceptanceCriteria": [
        "In dashboard/src/components/AdminPanel.tsx, find the ActivationForm local interface (or type) and add field extrato_csv: File | null",
        "In openActivationForm (or wherever activationForm state is initialized), set extrato_csv: null in the initial state object",
        "Inside the {isCAMode && (...)} JSX block in the activation modal, after the Centro de Custo CA field and before the modalActions div, add a <label className={styles.formLabel}> with text 'Extrato MP (account_statement CSV)' containing an <input type='file' accept='.csv' onChange={e => setActivationForm({ ...activationForm!, extrato_csv: e.target.files?.[0] ?? null })} />",
        "Below the file input, conditionally render the selected filename: {activationForm.extrato_csv && <span className={styles.startDatePreview}>✓ {activationForm.extrato_csv.name}</span>}",
        "Update isCAModeValid to also require extrato_csv: const isCAModeValid = !isCAMode || (activationForm.ca_conta_bancaria !== '' && activationForm.ca_centro_custo_variavel !== '' && activationForm.extrato_csv !== null)",
        "In handleActivationSubmit, when integration_mode === 'dashboard_ca', add extrato_csv: activationForm.extrato_csv ?? undefined to the config object passed to activateSeller",
        "When the mode toggle switches from dashboard_ca to dashboard_only (onClick of the dashboard_only button), also reset extrato_csv: null in setActivationForm",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Depends on US-F01 (ActivateSellerConfig must already have extrato_csv?: File). The file input does not need a ref — the onChange handler is sufficient. The startDatePreview CSS class already exists in AdminPanel.module.css and gives a small muted text style, reuse it for the filename display. File: dashboard/src/components/AdminPanel.tsx"
    },
    {
      "id": "US-F03",
      "title": "Add extrato CSV upload field to the Upgrade-to-CA modal",
      "description": "As an admin, I want a required file upload input in the Upgrade to CA modal so I can attach the historical extrato CSV before launching the backfill.",
      "acceptanceCriteria": [
        "In dashboard/src/components/AdminPanel.tsx, find the UpgradeForm local interface (or type) and add field extrato_csv: File | null",
        "In openUpgradeForm, set extrato_csv: null in the initial upgradeForm state",
        "Inside the {upgradeForm && (...)} JSX modal, after the Centro de Custo CA field and before the modalActions div, add a <label className={styles.formLabel}> with text 'Extrato MP (account_statement CSV) *' and an <input type='file' accept='.csv' onChange={e => setUpgradeForm({ ...upgradeForm!, extrato_csv: e.target.files?.[0] ?? null })} />",
        "Below the file input, conditionally render filename: {upgradeForm.extrato_csv && <span className={styles.startDatePreview}>✓ {upgradeForm.extrato_csv.name}</span>}",
        "Update the disabled condition on the 'Salvar e Iniciar Backfill' button to also require upgradeForm.extrato_csv: disabled={upgrading || !upgradeForm.ca_conta_bancaria || !upgradeForm.ca_centro_custo_variavel || !upgradeForm.extrato_csv}",
        "In handleUpgradeSubmit, add extrato_csv: upgradeForm.extrato_csv! to the UpgradeToCAConfig passed to upgradeToCA",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Depends on US-F01 (UpgradeToCAConfig must already have extrato_csv: File). Since extrato_csv is always required for upgrade (there is no mode toggle here), File(...) is always required — no conditional rendering needed. File: dashboard/src/components/AdminPanel.tsx"
    },
    {
      "id": "US-F04",
      "title": "Display extrato error and success feedback in both modals",
      "description": "As an admin, I want to see a clear error message inside the modal if the extrato CSV does not cover the required period, and a success summary of how many lines were ingested after a successful activation or upgrade.",
      "acceptanceCriteria": [
        "In AdminPanel.tsx, add two new state variables near the other modal states: const [activationError, setActivationError] = useState<string | null>(null); and const [upgradeError, setUpgradeError] = useState<string | null>(null)",
        "In openActivationForm (wherever activationForm is set to initial state), also call setActivationError(null)",
        "In openUpgradeForm, also call setUpgradeError(null)",
        "In handleActivationSubmit: if the result from activateSeller has status === 'error', call setActivationError(result.error_detail ?? 'Erro ao ativar seller') and do NOT close the modal (do not call setActivationForm(null)). If status === 'ok', optionally call window.alert with extrato summary then close: if (result.extrato_processed) { window.alert('Extrato processado: ' + result.extrato_processed.newly_ingested + ' linhas novas ingeridas.'); } setActivationForm(null);",
        "In handleUpgradeSubmit: same pattern — on error set upgradeError and keep modal open; on success optionally alert then setUpgradeForm(null)",
        "In the activation modal JSX, render the error message just before the modalActions div: {activationError && <p className={styles.formError}>{activationError}</p>}",
        "In the upgrade modal JSX, render the error message just before the modalActions div: {upgradeError && <p className={styles.formError}>{upgradeError}</p>}",
        "In dashboard/src/components/AdminPanel.module.css, add the class: .formError { color: var(--danger); font-size: var(--text-sm); margin-top: var(--space-1); margin-bottom: 0; }",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Depends on US-F01 (error_detail and extrato_processed fields in return type), US-F02 and US-F03 (modal JSX structure). The --danger CSS variable is already defined in the dashboard's index.css as #ef4444. The --text-sm and --space-1 variables are also already defined. Use window.alert for the success message to keep complexity low — no toast library needed. Files: dashboard/src/components/AdminPanel.tsx and dashboard/src/components/AdminPanel.module.css"
    }
  ]
}
